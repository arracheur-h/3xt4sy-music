<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Song Mixer â€” AI Mix Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
<style>
/* â”€â”€â”€ RESET & VARS â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #07070b;
  --surface:   #111118;
  --surface2:  #1a1a24;
  --border:    #2a2a38;
  --accent:    #ff5733;
  --accent2:   #ff8c5a;
  --gold:      #e8a832;
  --text:      #e2ddd8;
  --text-dim:  #666;
  --text-mid:  #999;
  --radius:    14px;
  --font-head: 'Bebas Neue', sans-serif;
  --font-body: 'Inter', sans-serif;
}

html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€â”€ NOISE OVERLAY â”€â”€â”€ */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.04'/%3E%3C/svg%3E");
  pointer-events: none;
}

/* â”€â”€â”€ AMBIENT GLOW â”€â”€â”€ */
.glow-1 {
  position: fixed; width: 600px; height: 600px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,87,51,0.08) 0%, transparent 70%);
  top: -200px; left: -150px; pointer-events: none; z-index: 0;
  filter: blur(60px);
}
.glow-2 {
  position: fixed; width: 500px; height: 500px; border-radius: 50%;
  background: radial-gradient(circle, rgba(232,168,50,0.06) 0%, transparent 70%);
  bottom: -180px; right: -100px; pointer-events: none; z-index: 0;
  filter: blur(50px);
}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
.wrapper { position: relative; z-index: 1; max-width: 960px; margin: 0 auto; padding: 0 24px 80px; }

/* â”€â”€â”€ HEADER â”€â”€â”€ */
header {
  text-align: center;
  padding: 64px 0 48px;
  position: relative;
}
.header-badge {
  display: inline-block;
  font-size: 11px;
  letter-spacing: 3.5px;
  text-transform: uppercase;
  color: var(--accent);
  margin-bottom: 14px;
  font-weight: 600;
}
header h1 {
  font-family: var(--font-head);
  font-size: clamp(52px, 11vw, 96px);
  letter-spacing: 4px;
  line-height: 0.95;
  background: linear-gradient(135deg, #fff 25%, var(--accent2) 60%, var(--accent) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
header p {
  color: var(--text-dim);
  font-size: 15px;
  margin-top: 16px;
  font-weight: 300;
  letter-spacing: 0.3px;
}

/* â”€â”€â”€ SECTION LABELS â”€â”€â”€ */
.section-label {
  font-size: 10px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--accent);
  font-weight: 600;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg, var(--border), transparent);
}

/* â”€â”€â”€ SONG LIBRARY GRID â”€â”€â”€ */
.library-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 14px;
  margin-bottom: 40px;
}

.song-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  cursor: pointer;
  transition: border-color 0.3s, box-shadow 0.3s, transform 0.2s;
  position: relative;
  user-select: none;
}
.song-card:hover { transform: translateY(-2px); border-color: #444; }
.song-card.selected {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent), 0 4px 24px rgba(255,87,51,0.15);
}

/* Checkmark ribbon */
.song-card .ribbon {
  position: absolute; top: 10px; right: 10px; z-index: 2;
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--accent);
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; color: #fff;
  opacity: 0; transform: scale(0.5);
  transition: opacity 0.25s, transform 0.25s;
  box-shadow: 0 2px 8px rgba(255,87,51,0.5);
}
.song-card.selected .ribbon { opacity: 1; transform: scale(1); }

/* YouTube embed container */
.yt-wrap {
  width: 100%;
  aspect-ratio: 16/9;
  background: #000;
  pointer-events: none; /* clicks go to card */
  position: relative;
}
.yt-wrap iframe {
  width: 100%; height: 100%; border: none; display: block;
}
/* Overlay to block iframe interaction */
.yt-wrap::after {
  content: ''; position: absolute; inset: 0; z-index: 1;
  background: transparent;
}

.song-info {
  padding: 14px 16px 16px;
}
.song-info .title {
  font-size: 15px; font-weight: 600; color: #fff;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.song-info .artist {
  font-size: 13px; color: var(--text-dim); margin-top: 3px;
}
.song-meta {
  display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;
}
.meta-tag {
  font-size: 11px; color: var(--text-mid);
  background: var(--surface2);
  padding: 3px 10px; border-radius: 20px;
  border: 1px solid var(--border);
}

/* Play button overlay on hover */
.song-card .play-overlay {
  position: absolute; inset: 0; z-index: 3;
  display: flex; align-items: flex-start; justify-content: center;
  padding-top: 30px;
  opacity: 0; transition: opacity 0.25s;
  pointer-events: none;
}
.song-card:hover .play-overlay { opacity: 1; }
.play-btn-float {
  background: rgba(255,87,51,0.9);
  border: none; border-radius: 50%;
  width: 42px; height: 42px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 16px rgba(255,87,51,0.4);
  pointer-events: auto; cursor: pointer;
  transition: transform 0.2s, background 0.2s;
}
.play-btn-float:hover { transform: scale(1.1); background: var(--accent); }
.play-btn-float svg { margin-left: 3px; }

/* â”€â”€â”€ SELECTED BAR â”€â”€â”€ */
.selected-bar {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px 22px;
  margin-bottom: 28px;
  display: flex; align-items: center; justify-content: space-between; gap: 16px;
  flex-wrap: wrap;
}
.selected-bar .count {
  font-size: 14px; color: var(--text-mid);
}
.selected-bar .count strong { color: var(--accent); font-size: 22px; }
.selected-pills { display: flex; flex-wrap: wrap; gap: 8px; flex: 1; justify-content: center; }
.selected-pills .pill {
  background: rgba(255,87,51,0.1);
  border: 1px solid rgba(255,87,51,0.3);
  border-radius: 30px;
  padding: 5px 14px;
  font-size: 13px; color: var(--accent2);
  font-weight: 500;
  animation: pill-pop 0.3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes pill-pop {
  from { transform: scale(0.6); opacity: 0; }
  to   { transform: scale(1);   opacity: 1; }
}

/* â”€â”€â”€ CTA BUTTON â”€â”€â”€ */
.cta-wrap { text-align: center; margin-bottom: 48px; }
.cta-btn {
  display: inline-flex; align-items: center; gap: 12px;
  background: linear-gradient(135deg, var(--accent), #e04420);
  border: none; border-radius: 50px;
  padding: 18px 44px;
  color: #fff; font-family: var(--font-body);
  font-size: 15px; font-weight: 600;
  letter-spacing: 1.5px; text-transform: uppercase;
  cursor: pointer;
  box-shadow: 0 6px 32px rgba(255,87,51,0.35);
  transition: transform 0.2s, box-shadow 0.2s, opacity 0.3s;
}
.cta-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 40px rgba(255,87,51,0.5); }
.cta-btn:active { transform: translateY(0); }
.cta-btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; box-shadow: none; }
.cta-btn .spinner {
  width: 20px; height: 20px; border: 2.5px solid rgba(255,255,255,0.3);
  border-top-color: #fff; border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€â”€ ERROR â”€â”€â”€ */
.error-box {
  background: rgba(200,60,60,0.1);
  border: 1px solid rgba(200,60,60,0.3);
  border-radius: 10px; padding: 14px 20px;
  color: #e77; font-size: 14px;
  margin-bottom: 24px;
  display: none;
}
.error-box.show { display: block; }

/* â”€â”€â”€ RESULTS â”€â”€â”€ */
.results-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px;
}
.results-header h2 {
  font-family: var(--font-head);
  font-size: 28px; letter-spacing: 2px; font-weight: 400;
  color: var(--text);
}
.results-header h2 span { color: var(--accent); }
.results-header .sub { font-size: 11px; color: var(--text-dim); letter-spacing: 1.5px; text-transform: uppercase; }

.result-list { display: flex; flex-direction: column; gap: 12px; }

/* Result Card */
.result-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  animation: fadeSlideUp 0.45s cubic-bezier(.16,1,.3,1) both;
}
@keyframes fadeSlideUp {
  from { opacity: 0; transform: translateY(22px); }
  to   { opacity: 1; transform: translateY(0); }
}

.result-head {
  display: flex; align-items: center; gap: 16px;
  padding: 18px 22px; cursor: pointer;
  transition: background 0.2s;
}
.result-head:hover { background: rgba(255,255,255,0.02); }

.result-rank {
  font-family: var(--font-head);
  font-size: 28px; color: var(--border);
  min-width: 34px; text-align: center;
  letter-spacing: 1px;
}
.result-card.top-1 .result-rank { color: var(--gold); }
.result-card.top-2 .result-rank { color: #b0b0b0; }
.result-card.top-3 .result-rank { color: #a0714a; }

.result-icon {
  width: 44px; height: 44px; border-radius: 12px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; color: #fff;
}

.result-text { flex: 1; min-width: 0; }
.result-text .title { font-size: 16px; font-weight: 600; color: #fff; }
.result-text .artist { font-size: 13px; color: var(--text-dim); margin-top: 2px; }

.result-score {
  flex-shrink: 0;
  font-family: var(--font-head);
  font-size: 22px;
  letter-spacing: 1px;
  padding: 6px 16px;
  border-radius: 30px;
}
.score-high { background: linear-gradient(135deg,rgba(255,87,51,0.15),rgba(255,140,90,0.1)); color: var(--accent2); border: 1px solid rgba(255,87,51,0.25); }
.score-med  { background: linear-gradient(135deg,rgba(232,168,50,0.15),rgba(232,168,50,0.08)); color: var(--gold);    border: 1px solid rgba(232,168,50,0.25); }
.score-low  { background: rgba(100,180,140,0.12); color: #6ec9a0; border: 1px solid rgba(100,180,140,0.25); }

.result-chevron {
  color: var(--text-dim); font-size: 18px;
  transition: transform 0.3s; margin-left: 6px;
}
.result-card.open .result-chevron { transform: rotate(180deg); }

/* Expanded body */
.result-body {
  max-height: 0; overflow: hidden;
  transition: max-height 0.45s cubic-bezier(.4,0,.2,1);
}
.result-card.open .result-body { max-height: 400px; }

.result-body-inner {
  border-top: 1px solid var(--border);
  padding: 20px 22px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}
.result-body-inner .block-label {
  font-size: 10px; letter-spacing: 2.5px; text-transform: uppercase;
  color: var(--accent); font-weight: 600; margin-bottom: 8px;
  display: flex; align-items: center; gap: 6px;
}
.result-body-inner .block-label .dot {
  width: 6px; height: 6px; border-radius: 50%; background: var(--accent);
}
.result-body-inner p {
  font-size: 14px; line-height: 1.65; color: var(--text-mid); font-weight: 300;
}
.result-body-inner .transition-block .block-label .dot { background: var(--gold); }
.result-body-inner .transition-block .block-label { color: var(--gold); }
.result-body-inner .transition-block p { font-style: italic; }

.result-tags {
  display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;
}
.result-tags .tag {
  font-size: 11px; color: var(--text-mid);
  background: var(--surface2); border: 1px solid var(--border);
  padding: 3px 11px; border-radius: 20px;
}

/* â”€â”€â”€ SOUNDBARS ANIMATION (decorative footer) â”€â”€â”€ */
.soundbars {
  display: flex; align-items: flex-end; justify-content: center;
  gap: 4px; height: 40px; margin-top: 60px; opacity: 0.18;
}
.soundbars .bar {
  width: 4px; border-radius: 2px;
  background: linear-gradient(180deg, var(--accent), var(--accent2));
  animation: barPulse 1.4s ease-in-out infinite alternate;
}
@keyframes barPulse {
  from { height: 8px; }
  to   { height: 36px; }
}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media (max-width: 600px) {
  .library-grid { grid-template-columns: 1fr; }
  .result-body-inner { grid-template-columns: 1fr; }
  .selected-bar { flex-direction: column; align-items: flex-start; }
}
</style>
</head>
<body>

<div class="glow-1"></div>
<div class="glow-2"></div>

<div class="wrapper">

  <!-- HEADER -->
  <header>
    <div class="header-badge">â™« AI Mix Studio</div>
    <h1>SONG MIXER</h1>
    <p>SÃ©lectionne tes morceaux. L'IA analyse et propose le mix parfait.</p>
  </header>

  <!-- LIBRARY -->
  <div class="section-label">BibliothÃ¨que de morceaux</div>
  <div class="library-grid" id="libraryGrid"></div>

  <!-- SELECTED BAR -->
  <div class="selected-bar" id="selectedBar" style="display:none;">
    <div class="count"><strong id="selCount">0</strong> morceau(x) sÃ©lectionnÃ©(s)</div>
    <div class="selected-pills" id="selPills"></div>
  </div>

  <!-- ERROR -->
  <div class="error-box" id="errorBox"></div>

  <!-- CTA -->
  <div class="cta-wrap">
    <button class="cta-btn" id="ctaBtn" disabled onclick="runAI()">
      <span id="ctaIcon">âœ¦</span>
      <span id="ctaText">GÃ©nÃ©rer le Mix</span>
    </button>
  </div>

  <!-- RESULTS -->
  <div id="resultsSection" style="display:none;">
    <div class="results-header">
      <h2>Mix <span>SuggÃ©rÃ©</span></h2>
      <span class="sub">Ordre optimal Â· Transitions</span>
    </div>
    <div class="result-list" id="resultList"></div>
  </div>

  <!-- Decorative soundbars -->
  <div class="soundbars" id="soundbars"></div>
</div>

<!-- â”€â”€â”€ SCRIPT â”€â”€â”€ -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA â€” Song Library
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SONGS = [
  { id: "blinding",    ytId: "4vLMZtAyWTQ", title: "Blinding Lights",    artist: "The Weeknd",        genre: "Synthpop",   bpm: "171", key: "Câ™¯ min", mood: "Energetic", color: "linear-gradient(135deg,#c9185b,#7b1fa2)" },
  { id: "levitating", ytId: "TjFKah3K-pg", title: "Levitating",         artist: "Dua Lipa",         genre: "Disco-Pop",  bpm: "103", key: "C maj",  mood: "Joyful",    color: "linear-gradient(135deg,#1976d2,#00acc1)" },
  { id: "shapeofyou", ytId: "1el5s2m4M8Q", title: "Shape of You",       artist: "Ed Sheeran",       genre: "Pop",        bpm: "96",  key: "Aâ™­ maj", mood: "Playful",   color: "linear-gradient(135deg,#43a047,#00897b)" },
  { id: "uptown",     ytId: "kVJHMRxl1w0", title: "Uptown Funk",        artist: "Bruno Mars",       genre: "Funk-Pop",   bpm: "115", key: "Eâ™­ min", mood: "Fun",       color: "linear-gradient(135deg,#f57c00,#e53935)" },
  { id: "hotline",    ytId: "uxnMQiWb35M", title: "Hotline Bling",      artist: "Drake",            genre: "R&B",        bpm: "80",  key: "Câ™¯ min", mood: "Mellow",    color: "linear-gradient(135deg,#5e35b1,#3949ab)" },
  { id: "happy",      ytId: "y82x7MkwahE", title: "Happy",              artist: "Pharrell Williams", genre: "Soul-Pop",   bpm: "160", key: "F maj",  mood: "Joyful",    color: "linear-gradient(135deg,#ffb300,#ff8f00)" },
  { id: "despacito",  ytId: "7pdAmnPX0Zs", title: "Despacito",          artist: "Luis Fonsi",       genre: "Reggaeton",  bpm: "128", key: "A min",  mood: "Romantic",  color: "linear-gradient(135deg,#d81b60,#f06292)" },
  { id: "loseyou",    ytId: "6JlK293czL8", title: "Lose Yourself",      artist: "Eminem",           genre: "Hip-Hop",    bpm: "171", key: "D min",  mood: "Intense",   color: "linear-gradient(135deg,#37474f,#546e7a)" },
  { id: "rolling",    ytId: "rYwsLeoWgdY", title: "Rolling in the Deep", artist: "Adele",           genre: "Blues-Rock", bpm: "110", key: "C min",  mood: "Powerful",  color: "linear-gradient(135deg,#6d4c41,#4e342e)" },
  { id: "someone",    ytId: "joJWNlyryDJ", title: "Someone Like You",   artist: "Adele",            genre: "Ballad",     bpm: "108", key: "A maj",  mood: "Melancholy", color: "linear-gradient(135deg,#4527a0,#283593)" },
  { id: "badguy",     ytId: "UyDtG_rxOoY", title: "Bad Guy",            artist: "Billie Eilish",    genre: "Alt-Pop",    bpm: "138", key: "Eâ™­ min", mood: "Edgy",      color: "linear-gradient(135deg,#212121,#546e7a)" },
  { id: "bohemian",   ytId: "9k0c85ry_a8", title: "Bohemian Rhapsody",  artist: "Queen",            genre: "Rock",       bpm: "72",  key: "Bâ™­ maj", mood: "Epic",      color: "linear-gradient(135deg,#b71c1c,#d32f2f)" },
  { id: "stayingalive", ytId: "I_cijC-r864", title: "Stayin' Alive",    artist: "Bee Gees",        genre: "Disco",      bpm: "103", key: "A min",  mood: "Groovy",    color: "linear-gradient(135deg,#00695c,#00897b)" },
  { id: "billie-jean", ytId: "Fq3GSzPJ3pQ", title: "Billie Jean",       artist: "Michael Jackson",  genre: "Pop-Funk",   bpm: "117", key: "Câ™¯ min", mood: "Groovy",    color: "linear-gradient(135deg,#1a237e,#283593)" },
  { id: "take-on-me",  ytId: "9ID_tY57s6g", title: "Take On Me",        artist: "a-ha",             genre: "Synth-Pop",  bpm: "138", key: "A maj",  mood: "Upbeat",    color: "linear-gradient(135deg,#00838f,#4dd0e1)" },
  { id: "creep",       ytId: "XbAccE9QdZY", title: "Creep",             artist: "Radiohead",        genre: "Alt-Rock",   bpm: "92",  key: "G maj",  mood: "Introspective", color: "linear-gradient(135deg,#37474f,#78909c)" },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selected = new Set();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER LIBRARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLibrary() {
  const grid = document.getElementById('libraryGrid');
  grid.innerHTML = SONGS.map((s, i) => `
    <div class="song-card" id="card-${s.id}" onclick="toggleSong('${s.id}')">
      <div class="ribbon">âœ“</div>
      <div class="play-overlay">
        <button class="play-btn-float" onclick="event.stopPropagation(); playVideo('${s.id}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="#fff"><polygon points="5,3 19,12 5,21"/></svg>
        </button>
      </div>
      <div class="yt-wrap" id="yt-${s.id}">
        <iframe src="https://www.youtube.com/embed/${s.ytId}?autoplay=0&controls=1&rel=0&modestbranding=1" 
                allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen></iframe>
      </div>
      <div class="song-info">
        <div class="title">${s.title}</div>
        <div class="artist">${s.artist}</div>
        <div class="result-tags">
          <span class="tag">â™ª ${s.bpm} BPM</span>
          <span class="tag">ğŸµ ${s.key}</span>
          <span class="tag">${s.genre}</span>
        </div>
      </div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SELECTION LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSong(id) {
  if (selected.has(id)) selected.delete(id);
  else selected.add(id);
  updateUI();
}

function updateUI() {
  // Cards
  SONGS.forEach(s => {
    document.getElementById('card-' + s.id).classList.toggle('selected', selected.has(s.id));
  });
  // Pills bar
  const bar  = document.getElementById('selectedBar');
  const pills = document.getElementById('selPills');
  document.getElementById('selCount').textContent = selected.size;
  if (selected.size === 0) { bar.style.display = 'none'; pills.innerHTML = ''; }
  else {
    bar.style.display = 'flex';
    pills.innerHTML = [...selected].map(id => {
      const s = SONGS.find(x => x.id === id);
      return `<span class="pill">${s.title}</span>`;
    }).join('');
  }
  // CTA
  document.getElementById('ctaBtn').disabled = selected.size < 2;
  // Hide old results
  document.getElementById('resultsSection').style.display = 'none';
  hideError();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAY VIDEO (full-screen-ish via iframe focus)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playVideo(id) {
  const s = SONGS.find(x => x.id === id);
  const wrap = document.getElementById('yt-' + id);
  // Replace iframe with autoplay version
  wrap.innerHTML = `<iframe src="https://www.youtube.com/embed/${s.ytId}?autoplay=1&controls=1&rel=0&modestbranding=1" 
    allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
  // Make this card's yt-wrap clickable temporarily
  wrap.style.pointerEvents = 'auto';
  setTimeout(() => { wrap.style.pointerEvents = 'none'; }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ERROR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showError(msg) {
  const el = document.getElementById('errorBox');
  el.textContent = 'âš  ' + msg;
  el.classList.add('show');
}
function hideError() { document.getElementById('errorBox').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI â€” Build prompt & call Claude
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildPrompt() {
  const tracks = [...selected].map(id => {
    const s = SONGS.find(x => x.id === id);
    return `- "${s.title}" par ${s.artist} | Genre: ${s.genre} | BPM: ${s.bpm} | TonalitÃ©: ${s.key} | Mood: ${s.mood}`;
  }).join('\n');

  return `Tu es un DJ professionnel et expert en mixing. Le DJ a sÃ©lectionnÃ© ces morceaux pour un mix :

${tracks}

Ta mission :
1. Propose un ordre de lecture OPTIMAL pour ces morceaux (du plus doux au plus intense, ou une logique narrative qui accroche l'audience).
2. Pour chaque morceau dans l'ordre, donne un score de "fluiditÃ©" (0â€“100) qui indique Ã  quel point il enchaÃ®ne bien avec le morceau prÃ©cÃ©dent.
3. SuggÃ¨re une transition concrÃ¨te entre chaque paire de morceaux (crossfade, drop, build-up, etc.).
4. Si un morceau ne s'intÃ¨gre pas bien, suggÃ¨re comment le modifier ou Ã  quel moment le placer.

RÃ©ponds UNIQUEMENT en JSON valide (pas de markdown, pas de \`\`\`), un tableau d'objets dans cet ordre exact :
[
  {
    "order": 1,
    "title": "...",
    "artist": "...",
    "genre": "...",
    "bpm": "...",
    "key": "...",
    "fluidityScore": 85,
    "transitionFrom": "Description de comment on arrive Ã  ce morceau depuis le prÃ©cÃ©dent (ou 'Morceau d'ouverture' si c'est le premier).",
    "djTip": "Conseil du DJ pour maximiser l'impact de ce morceau dans le mix.",
    "vibe": "Courte description de l'ambiance crÃ©Ã©e Ã  ce moment du mix."
  }
]`;
}

async function runAI() {
  if (selected.size < 2) return;
  hideError();
  const btn = document.getElementById('ctaBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span><span>Analyse en coursâ€¦</span>';

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1200,
        messages: [{ role: 'user', content: buildPrompt() }]
      })
    });
    if (!res.ok) throw new Error('API error ' + res.status);
    const data = await res.json();
    const raw = data.content.map(b => b.text || '').join('');
    const clean = raw.replace(/```json|```/g, '').trim();
    const parsed = JSON.parse(clean);
    renderResults(parsed);
  } catch(e) {
    showError('Impossible de gÃ©nÃ©rer le mix. VÃ©rifie ta connexion ou rÃ©essaie.');
    console.error(e);
  } finally {
    btn.disabled = selected.size < 2;
    btn.innerHTML = '<span>âœ¦</span><span>GÃ©nÃ©rer le Mix</span>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(tracks) {
  const section = document.getElementById('resultsSection');
  const list    = document.getElementById('resultList');
  section.style.display = 'block';

  // Find color from SONGS data
  function getColor(title) {
    const match = SONGS.find(s => s.title.toLowerCase() === title.toLowerCase());
    return match ? match.color : 'linear-gradient(135deg,#444,#222)';
  }

  list.innerHTML = tracks.map((t, i) => {
    const score = t.fluidityScore || 80;
    const scoreClass = score >= 80 ? 'score-high' : score >= 60 ? 'score-med' : 'score-low';
    const rankClass = i === 0 ? 'top-1' : i === 1 ? 'top-2' : i === 2 ? 'top-3' : '';
    const color = getColor(t.title);
    return `
    <div class="result-card ${rankClass}" style="animation-delay:${i*0.07}s" id="rc-${i}">
      <div class="result-head" onclick="toggleResult(${i})">
        <div class="result-rank">${i+1}</div>
        <div class="result-icon" style="background:${color}">â™«</div>
        <div class="result-text">
          <div class="title">${t.title}</div>
          <div class="artist">${t.artist} Â· <span style="color:var(--text-dim)">${t.genre || ''}</span></div>
        </div>
        <div class="result-score ${scoreClass}">${score}%</div>
        <div class="result-chevron">â–¾</div>
      </div>
      <div class="result-body">
        <div class="result-body-inner">
          <div class="why-block">
            <div class="block-label"><span class="dot"></span> Transition</div>
            <p>${t.transitionFrom || 'â€”'}</p>
          </div>
          <div class="transition-block">
            <div class="block-label"><span class="dot"></span> Conseil DJ</div>
            <p>${t.djTip || 'â€”'}</p>
          </div>
        </div>
        <div style="padding:0 22px 18px;">
          <div class="result-tags">
            <span class="tag">â™ª ${t.bpm || '?'} BPM</span>
            <span class="tag">ğŸµ ${t.key || '?'}</span>
            ${t.vibe ? `<span class="tag" style="color:var(--accent2);border-color:rgba(255,87,51,0.3);background:rgba(255,87,51,0.08)">${t.vibe}</span>` : ''}
          </div>
        </div>
      </div>
    </div>`;
  }).join('');

  // scroll into view
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function toggleResult(i) {
  const card = document.getElementById('rc-' + i);
  // Close all others
  document.querySelectorAll('.result-card').forEach((c,j) => { if(j!==i) c.classList.remove('open'); });
  card.classList.toggle('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOUNDBARS DECORATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
  const el = document.getElementById('soundbars');
  el.innerHTML = Array.from({length:40}, (_,i) =>
    `<div class="bar" style="animation-delay:${(i*0.07)%1.4}s; height:${8+Math.sin(i*0.5)*12}px"></div>`
  ).join('');
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderLibrary();
</script>
</body>
</html>
