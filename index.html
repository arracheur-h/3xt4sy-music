<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>3xt4sy Music</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESET & VARS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:         #06060a;
  --surf:       #0f0f16;
  --surf2:      #181822;
  --border:     #26262f;
  --accent:     #ff5733;
  --accent-lo:  rgba(255,87,51,.13);
  --accent2:    #ff8c5a;
  --gold:       #e8a832;
  --text:       #ddd8d2;
  --dim:        #5a5a62;
  --mid:        #8a8a92;
  --r:          12px;
}

html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€ noise grain â”€â”€ */
body::before {
  content:''; position:fixed; inset:0; z-index:0; pointer-events:none; opacity:.035;
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

/* â”€â”€ ambient glows â”€â”€ */
.g1 { position:fixed; width:700px; height:700px; border-radius:50%; top:-280px; left:-200px; pointer-events:none; z-index:0; background:radial-gradient(circle,rgba(255,87,51,.07) 0%,transparent 70%); filter:blur(70px); }
.g2 { position:fixed; width:550px; height:550px; border-radius:50%; bottom:-220px; right:-120px; pointer-events:none; z-index:0; background:radial-gradient(circle,rgba(232,168,50,.05) 0%,transparent 70%); filter:blur(60px); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap { position:relative; z-index:1; max-width:980px; margin:0 auto; padding:0 22px 90px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOP BAR (lang + api key) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  display:flex; align-items:center; justify-content:space-between;
  padding:18px 0; gap:12px; flex-wrap:wrap;
}
.lang-pills { display:flex; gap:6px; }
.lang-btn {
  background:var(--surf2); border:1px solid var(--border); border-radius:30px;
  padding:6px 16px; font-size:13px; font-weight:600; color:var(--mid);
  cursor:pointer; transition:all .2s; letter-spacing:.5px; font-family:inherit;
}
.lang-btn:hover { border-color:#555; color:#fff; }
.lang-btn.active { background:var(--accent-lo); border-color:var(--accent); color:var(--accent2); }

.api-row { display:flex; gap:8px; align-items:center; }
.api-row input {
  background:var(--surf2); border:1px solid var(--border); border-radius:8px;
  padding:7px 14px; font-size:13px; color:#fff; width:240px; max-width:55vw;
  font-family:inherit; transition:border .25s;
}
.api-row input:focus { outline:none; border-color:var(--accent); }
.api-row input::placeholder { color:var(--dim); }
.api-row .key-icon { color:var(--dim); font-size:16px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header { text-align:center; padding:44px 0 40px; }
.header-badge { font-size:11px; letter-spacing:3.5px; text-transform:uppercase; color:var(--accent); font-weight:600; margin-bottom:12px; display:block; }
header h1 {
  font-family:'Bebas Neue',sans-serif;
  font-size:clamp(54px,12vw,104px);
  letter-spacing:5px; line-height:.92;
  background:linear-gradient(135deg,#fff 20%,var(--accent2) 55%,var(--accent) 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
}
header p { color:var(--dim); font-size:15px; margin-top:14px; font-weight:300; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SECTION LABEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec-label {
  font-size:10px; letter-spacing:3px; text-transform:uppercase;
  color:var(--accent); font-weight:600; margin-bottom:16px;
  display:flex; align-items:center; gap:10px;
}
.sec-label::after { content:''; flex:1; height:1px; background:linear-gradient(90deg,var(--border),transparent); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LIBRARY GRID â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lib-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(270px,1fr));
  gap:14px; margin-bottom:32px;
}

.card {
  background:var(--surf); border:1px solid var(--border); border-radius:var(--r);
  overflow:hidden; position:relative;
  transition:border-color .3s, box-shadow .3s, transform .2s;
}
.card:hover { transform:translateY(-2px); border-color:#3a3a44; }
.card.sel { border-color:var(--accent); box-shadow:0 0 0 1px var(--accent),0 4px 22px rgba(255,87,51,.18); }

/* yt container â€” pointer-events ON so player works */
.yt-box { width:100%; aspect-ratio:16/9; background:#000; position:relative; overflow:hidden; }
.yt-box iframe { width:100%; height:100%; border:none; display:block; }

/* action strip under video */
.card-actions {
  display:flex; align-items:center; gap:0;
  background:var(--surf2); border-top:1px solid var(--border);
}
.card-actions button {
  flex:1; padding:11px 0; border:none; background:transparent;
  color:var(--mid); font-size:13px; font-weight:500; cursor:pointer;
  font-family:inherit; transition:all .2s; display:flex; align-items:center; justify-content:center; gap:6px;
  letter-spacing:.3px;
}
.card-actions button:hover { background:rgba(255,255,255,.04); color:#fff; }
.card-actions button.sel-btn.active { color:var(--accent); background:var(--accent-lo); }

/* info strip */
.card-info { padding:13px 16px 15px; }
.card-info .title { font-size:15px; font-weight:600; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.card-info .artist { font-size:13px; color:var(--dim); margin-top:2px; }
.card-tags { display:flex; gap:6px; margin-top:9px; flex-wrap:wrap; }
.card-tags span { font-size:11px; color:var(--mid); background:var(--surf2); border:1px solid var(--border); padding:2px 9px; border-radius:18px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SELECTED BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sel-bar {
  background:var(--surf); border:1px solid var(--border); border-radius:var(--r);
  padding:16px 20px; margin-bottom:24px;
  display:flex; align-items:center; gap:14px; flex-wrap:wrap;
}
.sel-bar .cnt { font-size:13px; color:var(--mid); white-space:nowrap; }
.sel-bar .cnt strong { color:var(--accent); font-size:20px; }
.sel-pills { display:flex; flex-wrap:wrap; gap:7px; flex:1; }
.pill {
  background:var(--accent-lo); border:1px solid rgba(255,87,51,.28); border-radius:28px;
  padding:4px 13px; font-size:13px; color:var(--accent2); font-weight:500;
  animation:popIn .3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes popIn { from{transform:scale(.55);opacity:0} to{transform:scale(1);opacity:1} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ERROR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.err {
  background:rgba(200,55,55,.1); border:1px solid rgba(200,55,55,.28); border-radius:10px;
  padding:13px 18px; color:#e77; font-size:14px; margin-bottom:20px; display:none;
}
.err.show { display:block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CTA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cta-wrap { text-align:center; margin-bottom:48px; }
.cta {
  display:inline-flex; align-items:center; gap:11px;
  background:linear-gradient(135deg,var(--accent),#d63a14);
  border:none; border-radius:50px; padding:17px 42px;
  color:#fff; font-family:inherit; font-size:15px; font-weight:600;
  letter-spacing:1.5px; text-transform:uppercase; cursor:pointer;
  box-shadow:0 6px 30px rgba(255,87,51,.35);
  transition:transform .2s, box-shadow .2s, opacity .3s;
}
.cta:hover { transform:translateY(-2px); box-shadow:0 8px 38px rgba(255,87,51,.5); }
.cta:disabled { opacity:.3; cursor:not-allowed; transform:none; box-shadow:none; }
.cta .spin {
  width:18px; height:18px; border:2.5px solid rgba(255,255,255,.3); border-top-color:#fff;
  border-radius:50%; animation:spin .65s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.res-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; flex-wrap:wrap; gap:8px; }
.res-head h2 { font-family:'Bebas Neue',sans-serif; font-size:30px; letter-spacing:2px; }
.res-head h2 span { color:var(--accent); }
.res-head .sub { font-size:11px; color:var(--dim); letter-spacing:1.5px; text-transform:uppercase; }

.res-list { display:flex; flex-direction:column; gap:11px; }

.rc {
  background:var(--surf); border:1px solid var(--border); border-radius:var(--r);
  overflow:hidden; animation:fadeUp .42s cubic-bezier(.16,1,.3,1) both;
}
@keyframes fadeUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

.rc-head {
  display:flex; align-items:center; gap:14px; padding:17px 20px;
  cursor:pointer; transition:background .2s;
}
.rc-head:hover { background:rgba(255,255,255,.025); }

.rc-rank { font-family:'Bebas Neue',sans-serif; font-size:26px; color:var(--border); min-width:30px; text-align:center; }
.rc.r1 .rc-rank { color:var(--gold); }
.rc.r2 .rc-rank { color:#b8b8b8; }
.rc.r3 .rc-rank { color:#a07850; }

.rc-ico { width:42px; height:42px; border-radius:11px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:19px; color:#fff; }
.rc-txt { flex:1; min-width:0; }
.rc-txt .title { font-size:15px; font-weight:600; color:#fff; }
.rc-txt .artist { font-size:13px; color:var(--dim); margin-top:2px; }

.rc-score { flex-shrink:0; font-family:'Bebas Neue',sans-serif; font-size:20px; letter-spacing:1px; padding:5px 14px; border-radius:28px; }
.s-hi { background:linear-gradient(135deg,rgba(255,87,51,.14),rgba(255,140,90,.08)); color:var(--accent2); border:1px solid rgba(255,87,51,.24); }
.s-md { background:linear-gradient(135deg,rgba(232,168,50,.14),rgba(232,168,50,.07)); color:var(--gold); border:1px solid rgba(232,168,50,.24); }
.s-lo { background:rgba(90,180,140,.1); color:#6ec9a0; border:1px solid rgba(90,180,140,.24); }

.rc-chev { color:var(--dim); font-size:16px; transition:transform .3s; }
.rc.open .rc-chev { transform:rotate(180deg); }

.rc-body { max-height:0; overflow:hidden; transition:max-height .4s cubic-bezier(.4,0,.2,1); }
.rc.open .rc-body { max-height:360px; }
.rc-body-in {
  border-top:1px solid var(--border); padding:18px 20px;
  display:grid; grid-template-columns:1fr 1fr; gap:18px;
}
.blk-label { font-size:10px; letter-spacing:2.5px; text-transform:uppercase; color:var(--accent); font-weight:600; margin-bottom:7px; display:flex; align-items:center; gap:6px; }
.blk-label .d { width:6px; height:6px; border-radius:50%; background:var(--accent); }
.blk-label.gold { color:var(--gold); }
.blk-label.gold .d { background:var(--gold); }
.rc-body-in p { font-size:14px; line-height:1.6; color:var(--mid); font-weight:300; }
.rc-body-in .tip p { font-style:italic; }
.rc-tags { display:flex; gap:7px; flex-wrap:wrap; padding:0 20px 16px; }
.rc-tags span { font-size:11px; color:var(--mid); background:var(--surf2); border:1px solid var(--border); padding:2px 10px; border-radius:18px; }
.rc-tags .vibe { color:var(--accent2); border-color:rgba(255,87,51,.28); background:var(--accent-lo); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SOUNDBARS FOOTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bars { display:flex; align-items:flex-end; justify-content:center; gap:4px; height:38px; margin-top:56px; opacity:.15; }
.bars .b { width:4px; border-radius:2px; background:linear-gradient(180deg,var(--accent),var(--accent2)); animation:bp 1.3s ease-in-out infinite alternate; }
@keyframes bp { from{height:6px} to{height:34px} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:580px){
  .lib-grid{grid-template-columns:1fr}
  .rc-body-in{grid-template-columns:1fr}
  .topbar{flex-direction:column;align-items:flex-start}
}
</style>
</head>
<body>

<div class="g1"></div>
<div class="g2"></div>

<div class="wrap">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="lang-pills">
      <button class="lang-btn active" onclick="setLang('fr')" id="btn-fr">FR</button>
      <button class="lang-btn"        onclick="setLang('en')" id="btn-en">EN</button>
    </div>
    <div class="api-row">
      <span class="key-icon">ğŸ”‘</span>
      <input type="password" id="apiKeyInput" placeholder="Anthropic API keyâ€¦" autocomplete="off" />
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <span class="header-badge" id="hBadge">â™« AI Mix Studio</span>
    <h1>3XT4SY<br>MUSIC</h1>
    <p id="hSub">SÃ©lectionne tes morceaux. L'IA crÃ©e le mix parfait.</p>
  </header>

  <!-- LIBRARY -->
  <div class="sec-label" id="secLib">BibliothÃ¨que</div>
  <div class="lib-grid" id="libGrid"></div>

  <!-- SELECTED BAR -->
  <div class="sel-bar" id="selBar" style="display:none">
    <div class="cnt"><strong id="selCnt">0</strong> <span id="selWord">morceau(x) sÃ©lectionnÃ©(s)</span></div>
    <div class="sel-pills" id="selPills"></div>
  </div>

  <!-- ERROR -->
  <div class="err" id="errBox"></div>

  <!-- CTA -->
  <div class="cta-wrap">
    <button class="cta" id="ctaBtn" disabled onclick="runAI()">
      <span id="ctaIcon">âœ¦</span>
      <span id="ctaText">GÃ©nÃ©rer le Mix</span>
    </button>
  </div>

  <!-- RESULTS -->
  <div id="resSection" style="display:none">
    <div class="res-head">
      <h2><span id="resTitleAccent">Mix</span> <span id="resTitlePlain">SuggÃ©rÃ©</span></h2>
      <span class="sub" id="resSub">Ordre optimal Â· Transitions</span>
    </div>
    <div class="res-list" id="resList"></div>
  </div>

  <!-- soundbars -->
  <div class="bars" id="bars"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ i18n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const T = {
  fr: {
    badge:"â™« AI Mix Studio",
    sub:"SÃ©lectionne tes morceaux. L'IA crÃ©e le mix parfait.",
    secLib:"BibliothÃ¨que",
    selWord:"morceau(x) sÃ©lectionnÃ©(s)",
    btnSel:"SÃ©lectionner",
    btnSelOn:"SÃ©lectionnÃ© âœ“",
    cta:"GÃ©nÃ©rer le Mix",
    ctaLoading:"Analyse en coursâ€¦",
    errNoKey:"Entre ta clÃ© API Anthropic en haut pour continuer.",
    errNoSel:"SÃ©lectionne au moins 2 morceaux.",
    errFetch:"Erreur lors de la gÃ©nÃ©ration. VÃ©rifie ta clÃ© API ou rÃ©essaie.",
    resTitleAccent:"Mix",
    resTitlePlain:"SuggÃ©rÃ©",
    resSub:"Ordre optimal Â· Transitions",
    lblTransition:"Transition",
    lblTip:"Conseil DJ",
  },
  en: {
    badge:"â™« AI Mix Studio",
    sub:"Pick your tracks. AI builds the perfect mix.",
    secLib:"Library",
    selWord:"track(s) selected",
    btnSel:"Select",
    btnSelOn:"Selected âœ“",
    cta:"Generate Mix",
    ctaLoading:"Analysingâ€¦",
    errNoKey:"Enter your Anthropic API key above to continue.",
    errNoSel:"Select at least 2 tracks.",
    errFetch:"Mix generation failed. Check your API key or try again.",
    resTitleAccent:"Mix",
    resTitlePlain:"Suggested",
    resSub:"Optimal order Â· Transitions",
    lblTransition:"Transition",
    lblTip:"DJ Tip",
  }
};
let lang = 'fr';

function setLang(l) {
  lang = l;
  document.getElementById('btn-fr').className = 'lang-btn' + (l==='fr'?' active':'');
  document.getElementById('btn-en').className = 'lang-btn' + (l==='en'?' active':'');
  applyLang();
  renderLibrary();
  updateUI();
}

function t(key){ return T[lang][key] || key; }

function applyLang(){
  document.getElementById('hBadge').textContent    = t('badge');
  document.getElementById('hSub').textContent     = t('sub');
  document.getElementById('secLib').textContent   = t('secLib');
  document.getElementById('selWord').textContent  = t('selWord');
  document.getElementById('ctaText').textContent  = t('cta');
  document.getElementById('resTitleAccent').textContent = t('resTitleAccent');
  document.getElementById('resTitlePlain').textContent  = t('resTitlePlain');
  document.getElementById('resSub').textContent   = t('resSub');
}

// â”€â”€ data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SONGS = [
  { id:"blinding",     ytId:"4vLMZtAyWTQ", title:"Blinding Lights",     artist:"The Weeknd",         genre:"Synthpop",    bpm:"171", key:"Câ™¯m", mood:"Energetic",     color:"linear-gradient(135deg,#c9185b,#7b1fa2)" },
  { id:"levitating",   ytId:"TjFKah3K-pg", title:"Levitating",          artist:"Dua Lipa",           genre:"Disco-Pop",   bpm:"103", key:"C",   mood:"Joyful",        color:"linear-gradient(135deg,#1976d2,#00acc1)" },
  { id:"shapeofyou",   ytId:"1el5s2m4M8Q", title:"Shape of You",        artist:"Ed Sheeran",         genre:"Pop",         bpm:"96",  key:"Aâ™­",  mood:"Playful",       color:"linear-gradient(135deg,#43a047,#00897b)" },
  { id:"uptown",       ytId:"kVJHMRxl1w0", title:"Uptown Funk",         artist:"Bruno Mars",         genre:"Funk-Pop",    bpm:"115", key:"Eâ™­m", mood:"Fun",           color:"linear-gradient(135deg,#f57c00,#e53935)" },
  { id:"hotline",      ytId:"uxnMQiWb35M", title:"Hotline Bling",       artist:"Drake",              genre:"R&B",         bpm:"80",  key:"Câ™¯m", mood:"Mellow",        color:"linear-gradient(135deg,#5e35b1,#3949ab)" },
  { id:"happy",        ytId:"y82x7MkwahE", title:"Happy",               artist:"Pharrell Williams",  genre:"Soul-Pop",    bpm:"160", key:"F",   mood:"Joyful",        color:"linear-gradient(135deg,#ffb300,#ff8f00)" },
  { id:"despacito",    ytId:"7pdAmnPX0Zs", title:"Despacito",           artist:"Luis Fonsi",         genre:"Reggaeton",   bpm:"128", key:"Am",  mood:"Romantic",      color:"linear-gradient(135deg,#d81b60,#f06292)" },
  { id:"loseyou",      ytId:"6JlK293czL8", title:"Lose Yourself",       artist:"Eminem",             genre:"Hip-Hop",     bpm:"171", key:"Dm",  mood:"Intense",       color:"linear-gradient(135deg,#37474f,#546e7a)" },
  { id:"rolling",      ytId:"rYwsLeoWgdY", title:"Rolling in the Deep", artist:"Adele",              genre:"Blues-Rock",  bpm:"110", key:"Cm",  mood:"Powerful",      color:"linear-gradient(135deg,#6d4c41,#4e342e)" },
  { id:"someone",      ytId:"joJWNlyryDJ", title:"Someone Like You",    artist:"Adele",              genre:"Ballad",      bpm:"108", key:"A",   mood:"Melancholy",    color:"linear-gradient(135deg,#4527a0,#283593)" },
  { id:"badguy",       ytId:"UyDtG_rxOoY", title:"Bad Guy",             artist:"Billie Eilish",      genre:"Alt-Pop",     bpm:"138", key:"Eâ™­m", mood:"Edgy",          color:"linear-gradient(135deg,#212121,#546e7a)" },
  { id:"bohemian",     ytId:"9k0c85ry_a8", title:"Bohemian Rhapsody",   artist:"Queen",              genre:"Rock",        bpm:"72",  key:"Bâ™­",  mood:"Epic",          color:"linear-gradient(135deg,#b71c1c,#d32f2f)" },
  { id:"stayingalive", ytId:"I_cijC-r864", title:"Stayin' Alive",       artist:"Bee Gees",          genre:"Disco",       bpm:"103", key:"Am",  mood:"Groovy",        color:"linear-gradient(135deg,#00695c,#00897b)" },
  { id:"billiejean",   ytId:"Fq3GSzPJ3pQ", title:"Billie Jean",         artist:"Michael Jackson",   genre:"Pop-Funk",    bpm:"117", key:"Câ™¯m", mood:"Groovy",        color:"linear-gradient(135deg,#1a237e,#283593)" },
  { id:"takeonme",     ytId:"9ID_tY57s6g", title:"Take On Me",          artist:"a-ha",               genre:"Synth-Pop",   bpm:"138", key:"A",   mood:"Upbeat",        color:"linear-gradient(135deg,#00838f,#4dd0e1)" },
  { id:"creep",        ytId:"XbAccE9QdZY", title:"Creep",               artist:"Radiohead",          genre:"Alt-Rock",    bpm:"92",  key:"G",   mood:"Introspective", color:"linear-gradient(135deg,#37474f,#78909c)" },
];

// â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selected = new Set();

// â”€â”€ render library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLibrary(){
  document.getElementById('libGrid').innerHTML = SONGS.map(s => {
    const isSel = selected.has(s.id);
    return `
    <div class="card ${isSel?'sel':''}" id="card-${s.id}">
      <div class="yt-box">
        <iframe src="https://www.youtube.com/embed/${s.ytId}?rel=0&modestbranding=1"
                allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="card-actions">
        <button onclick="toggleSong('${s.id}')" class="sel-btn ${isSel?'active':''}">${isSel? t('btnSelOn') : t('btnSel')}</button>
      </div>
      <div class="card-info">
        <div class="title">${s.title}</div>
        <div class="artist">${s.artist}</div>
        <div class="card-tags">
          <span>â™ª ${s.bpm} BPM</span>
          <span>ğŸµ ${s.key}</span>
          <span>${s.genre}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ toggle selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSong(id){
  selected.has(id) ? selected.delete(id) : selected.add(id);
  const card = document.getElementById('card-'+id);
  const isSel = selected.has(id);
  card.classList.toggle('sel', isSel);
  card.querySelector('.sel-btn').className = 'sel-btn' + (isSel?' active':'');
  card.querySelector('.sel-btn').textContent = isSel ? t('btnSelOn') : t('btnSel');
  updateUI();
}

// â”€â”€ update shared UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUI(){
  const bar  = document.getElementById('selBar');
  const pills = document.getElementById('selPills');
  document.getElementById('selCnt').textContent = selected.size;
  document.getElementById('selWord').textContent = t('selWord');

  if(!selected.size){ bar.style.display='none'; pills.innerHTML=''; }
  else {
    bar.style.display='flex';
    pills.innerHTML = [...selected].map(id => {
      const s = SONGS.find(x=>x.id===id);
      return `<span class="pill">${s.title}</span>`;
    }).join('');
  }

  document.getElementById('ctaBtn').disabled = selected.size < 2;
  document.getElementById('resSection').style.display = 'none';
  hideErr();
}

// â”€â”€ errors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showErr(msg){ const e=document.getElementById('errBox'); e.textContent='âš  '+msg; e.classList.add('show'); }
function hideErr(){ document.getElementById('errBox').classList.remove('show'); }

// â”€â”€ build prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPrompt(){
  const tracks = [...selected].map(id=>{
    const s = SONGS.find(x=>x.id===id);
    return `- "${s.title}" by ${s.artist} | Genre: ${s.genre} | BPM: ${s.bpm} | Key: ${s.key} | Mood: ${s.mood}`;
  }).join('\n');

  return `You are a professional DJ and mixing expert. The DJ selected these tracks for a mix:

${tracks}

Your task:
1. Propose the OPTIMAL play order (smooth energy curve, key compatibility, narrative flow).
2. For each track give a "fluidity score" (0-100) showing how well it follows the previous one (first track = 100).
3. Suggest a concrete transition between each pair (crossfade, drop, build-up, echo-out, etc.).
4. If a track doesn't fit well, explain why and suggest the best position for it.

Reply ONLY with valid JSON (no markdown, no backticks), an array:
[
  {
    "order": 1,
    "title": "â€¦",
    "artist": "â€¦",
    "genre": "â€¦",
    "bpm": "â€¦",
    "key": "â€¦",
    "fluidityScore": 100,
    "transitionFrom": "Opening track â€” â€¦",
    "djTip": "â€¦",
    "vibe": "short vibe label"
  }
]`;
}

// â”€â”€ AI call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAI(){
  const key = document.getElementById('apiKeyInput').value.trim();
  if(!key){ showErr(t('errNoKey')); return; }
  if(selected.size<2){ showErr(t('errNoSel')); return; }

  hideErr();
  const btn = document.getElementById('ctaBtn');
  btn.disabled = true;
  btn.innerHTML = `<span class="spin"></span><span>${t('ctaLoading')}</span>`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key': key,
        'anthropic-version':'2023-06-01'
      },
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1200,
        messages:[{ role:'user', content: buildPrompt() }]
      })
    });

    if(!res.ok){
      const errData = await res.json().catch(()=>({}));
      throw new Error(errData?.error?.message || 'HTTP '+res.status);
    }

    const data = await res.json();
    const raw  = data.content.map(b=>b.text||'').join('');
    const clean = raw.replace(/```json|```/g,'').trim();
    const parsed = JSON.parse(clean);
    renderResults(parsed);
  } catch(e){
    showErr(t('errFetch') + ' â€” ' + e.message);
    console.error(e);
  } finally {
    btn.disabled = selected.size < 2;
    btn.innerHTML = `<span>âœ¦</span><span>${t('cta')}</span>`;
  }
}

// â”€â”€ render results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(tracks){
  const sec  = document.getElementById('resSection');
  const list = document.getElementById('resList');
  sec.style.display='block';

  function getColor(title){
    const m = SONGS.find(s=> s.title.toLowerCase()===title.toLowerCase());
    return m ? m.color : 'linear-gradient(135deg,#444,#222)';
  }

  list.innerHTML = tracks.map((tr,i)=>{
    const score = tr.fluidityScore ?? 80;
    const sc = score>=80?'s-hi': score>=60?'s-md':'s-lo';
    const rc = i===0?'r1': i===1?'r2': i===2?'r3':'';
    return `
    <div class="rc ${rc}" style="animation-delay:${i*.07}s" id="rc-${i}">
      <div class="rc-head" onclick="toggleRC(${i})">
        <div class="rc-rank">${i+1}</div>
        <div class="rc-ico" style="background:${getColor(tr.title)}">â™«</div>
        <div class="rc-txt">
          <div class="title">${tr.title}</div>
          <div class="artist">${tr.artist} Â· <span style="color:var(--dim)">${tr.genre||''}</span></div>
        </div>
        <div class="rc-score ${sc}">${score}%</div>
        <div class="rc-chev">â–¾</div>
      </div>
      <div class="rc-body">
        <div class="rc-body-in">
          <div>
            <div class="blk-label"><span class="d"></span>${t('lblTransition')}</div>
            <p>${tr.transitionFrom||'â€”'}</p>
          </div>
          <div class="tip">
            <div class="blk-label gold"><span class="d"></span>${t('lblTip')}</div>
            <p>${tr.djTip||'â€”'}</p>
          </div>
        </div>
        <div class="rc-tags">
          <span>â™ª ${tr.bpm||'?'} BPM</span>
          <span>ğŸµ ${tr.key||'?'}</span>
          ${tr.vibe?`<span class="vibe">${tr.vibe}</span>`:''}
        </div>
      </div>
    </div>`;
  }).join('');

  sec.scrollIntoView({ behavior:'smooth', block:'start' });
}

function toggleRC(i){
  const card = document.getElementById('rc-'+i);
  document.querySelectorAll('.rc').forEach((c,j)=>{ if(j!==i) c.classList.remove('open'); });
  card.classList.toggle('open');
}

// â”€â”€ soundbars decoration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('bars').innerHTML = Array.from({length:38},(_,i)=>
  `<div class="b" style="animation-delay:${(i*.08)%1.3}s;height:${7+Math.sin(i*.55)*11}px"></div>`
).join('');

// â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
applyLang();
renderLibrary();
</script>
</body>
</html>
